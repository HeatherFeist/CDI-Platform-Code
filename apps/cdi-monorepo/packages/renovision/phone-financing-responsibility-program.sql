# üì± Phone Financing & Responsibility Program
## *Earn Your Upgrade Through Platform Achievement*

---

## üéØ **The THREE Types of Donated Phones:**

### **Type 1: Stolen/Lost Phones**
- IMEI blacklisted
- Original owner can claim or donate
- ‚Üí Sweepstakes program (already covered)

### **Type 2: Contract Default Phones** ‚≠ê NEW!
- User broke contract early
- Network locked the phone (still owed $200-800)
- Phone sits in drawer, useless
- **Network lost money + customer**

### **Type 3: Clean Old Phones**
- Fully paid off
- User upgraded
- ‚Üí Refurbish for members

---

## üí° **The Contract Default Solution:**

### **Current Situation (Network's Problem):**

```
Customer finances iPhone ($1,000)
  ‚Üì
Pays 6 months ($250 paid)
  ‚Üì
Defaults/cancels service
  ‚Üì
Network locks phone (still owed $750)
  ‚Üì
Customer keeps locked phone (useless)
  ‚Üì
Network LOSES:
  - $750 remaining balance
  - Future monthly service ($50-80/month)
  - Customer relationship
```

**Network's Total Loss:** $750 device + $1,440/year service = **$2,190+ loss!**

---

## ü§ù **Your Solution (Win-Win-Win):**

### **The Nonprofit as "Payment Recovery Partner":**

```
Locked phone donated to nonprofit
  ‚Üì
We check IMEI ‚Üí See $750 still owed
  ‚Üì
Contact network: "We have your phone"
  ‚Üì
Network unlocks phone for us
  ‚Üì
We finance phone to EARNING member
  ‚Üì
Member pays weekly/monthly through platform
  ‚Üì
We pay network the $750 balance
  ‚Üì
Everyone wins! ‚Üì
```

### **The Three Winners:**

**1. Network Carrier:**
- ‚úÖ Recovers $750 device balance (written off before)
- ‚úÖ Gains new customer (member with service)
- ‚úÖ No collection costs
- ‚úÖ No bad debt

**2. Nonprofit:**
- ‚úÖ Helps members get phones (mission alignment)
- ‚úÖ Small handling fee ($5-10/month per phone)
- ‚úÖ Teaches financial responsibility
- ‚úÖ Builds credit history for members

**3. Earning Member:**
- ‚úÖ Gets quality phone (iPhone/Samsung worth $400-1,000)
- ‚úÖ Affordable payments ($15-25/week)
- ‚úÖ Builds credit through nonprofit
- ‚úÖ Owns phone after completion
- ‚úÖ No credit check needed (tier-based eligibility)

---

## üèÜ **Tier-Based Eligibility System:**

### **Philosophy: EARN Your Upgrade**

> "We don't just give phones to people in need.  
> We REWARD phones to people who EARN IT through hard work,  
> platform participation, and proving responsibility."

### **Eligibility Tiers:**

| Tier | Requirements | Phone Value | Weekly Payment |
|------|--------------|-------------|----------------|
| **Bronze** | 3 months active, 10+ jobs completed | Up to $300 | $10-15/week |
| **Silver** | 6 months active, 25+ jobs, 90% on-time | Up to $600 | $15-20/week |
| **Gold** | 12 months active, 50+ jobs, 95% on-time | Up to $1,000 | $20-25/week |
| **Platinum** | 24 months active, 100+ jobs, 98% on-time | Premium flagship | $25-30/week |

### **How Members Qualify:**

‚úÖ **Platform Activity:**
- Complete jobs through marketplace
- Deliver services on time
- Maintain good ratings (4.5+ stars)
- Pay voluntary donations consistently

‚úÖ **Financial Responsibility:**
- No missed payments on tool rentals
- Complete previous financing agreements
- History of meeting commitments

‚úÖ **Community Contribution:**
- Help other members
- Participate in events
- Positive reviews from customers

**Result:** Phone financing becomes a **REWARD for doing the right thing!**

---

## üí∞ **The Financing Structure:**

### **Example: Silver Tier Member Earns iPhone**

**Phone Details:**
- Donated iPhone 13 (network locked)
- Original balance owed: $600
- Network unlocks for nonprofit

**Member Financing:**
```
Phone Value: $600
Nonprofit handling fee: $60 (10%)
Total financed: $660

Weekly payment: $15
Term: 44 weeks (~10 months)
Ownership: After final payment

Weekly payment deducted from:
  - Job payments (automatic)
  - Voluntary donations
  - Direct payment if no jobs that week
```

### **Cash Flow (Nonprofit Perspective):**

**Upfront:**
- Receive phone: $0 (donated)
- Pay network balance: $600 (loan to member)

**Over 44 weeks:**
- Collect from member: $660 ($15/week √ó 44)
- Revenue: $60 handling fee
- Use for: Program costs, staff time, defaults

**If member defaults at week 20:**
- Collected: $300
- Lock phone remotely (via carrier partnership)
- Offer payment plan to reinstate
- If no reinstatement: Refurbish and reassign to new member
- Network already paid: No loss to carrier

---

## üîÑ **The Payment Integration:**

### **Auto-Deduction from Platform Earnings:**

```javascript
// When contractor gets paid for a job
const jobPayment = $500;

// Deductions happen in order:
1. Phone payment: $15 (if financing active)
2. Tool rental: $20 (if renting tools)
3. Platform fee: $0 (nonprofit members)
4. Voluntary donation: $75 (15% suggested)
   ‚Üì
Contractor receives: $390

// They never "miss" a payment!
```

### **Safety Nets:**

**No jobs this week?**
- Grace period: 2 weeks
- Notification: "Payment due, find a job or pay directly"
- Option: Pause financing (extend term by 1 week)
- Emergency fund: Nonprofit covers 1-2 payments if hardship

**Want to pay off early?**
- No prepayment penalty
- Save on handling fee (time value)
- Unlock phone immediately
- Boost tier status

---

## ü§ù **Network Partnership Pitch (Enhanced):**

### **"Device Recovery & Customer Acquisition Program"**

**Dear [Carrier Name]:**

We've identified a major revenue leak: **contract default phones sitting locked in drawers.**

Our 501(c)(3) nonprofit can turn this into a win-win-win.

### **The Problem You're Facing:**

- **$2.3 billion/year** in device financing defaults (industry-wide)
- Average loss per default: **$750 device + $1,440 service** = $2,190
- Collection costs: 15-25% of balance
- Customer relationship destroyed
- Phone sits unused

### **Our Solution:**

**Phase 1: Device Recovery**
```
Member donates locked phone to us (anonymously)
  ‚Üì
We check IMEI in your database
  ‚Üì
See: $600 still owed on contract
  ‚Üì
We contact you: "We can recover this"
```

**Phase 2: Partnership Agreement**
```
You unlock phone for our nonprofit use
  ‚Üì
We finance phone to EARNING member (tier-based)
  ‚Üì
We pay you the $600 balance over 6 months
  ‚Üì
Member gets phone + new service with you
  ‚Üì
You get: Recovered balance + NEW customer
```

**Phase 3: Long-term Value**
```
Member completes financing
  ‚Üì
Owns phone outright
  ‚Üì
Continues service with you (now paying)
  ‚Üì
Potential lifetime value: $3,600 (5 years √ó $60/month)
```

### **Your ROI:**

| Scenario | Current Reality | With Our Program |
|----------|----------------|------------------|
| **Device Balance** | Write-off ($750) | Recovered ($750) |
| **Service Revenue** | Lost ($0/month) | Gained ($60/month) |
| **Customer Relationship** | Dead | New customer |
| **Total 2-Year Value** | -$750 loss | +$2,190 gain |

**Net Swing: $2,940 per phone!** üöÄ

### **What We Need From You:**

1. **IMEI Database Access** (check balances owed)
2. **Device Unlock Authority** (for donated phones with balances)
3. **Payment Plan Agreement** (we pay balance over 3-6 months)
4. **Service Plan Partnership** (discounted rates for our members)

### **What You Get:**

‚úÖ **Immediate:** Recovered device balances ($$$ currently written off)
‚úÖ **Ongoing:** New customers (our members with unlocked phones)
‚úÖ **Long-term:** Customer retention (80%+ stay after financing)
‚úÖ **Bonus:** Brand reputation (helping nonprofit teach financial responsibility)

### **Pilot Program (90 Days):**

- Goal: Recover 50 contract-default phones
- Average balance: $600/phone
- Total recovery: **$30,000** you've already written off
- New customers: 50 members with service plans
- Revenue (2 years): **$72,000** ($60/month √ó 50 √ó 24)

**Net Value Created: $102,000 in 90 days!**

---

## üéì **Teaching Financial Responsibility:**

### **The Educational Component:**

When member qualifies for phone financing, they receive:

**1. Financial Literacy Module:**
- How phone financing works
- Credit implications (we report to credit bureaus as positive history)
- Budgeting with automatic payments
- Benefits of on-time payments (tier advancement)

**2. Personal Finance Coaching:**
- Assigned mentor (senior member)
- Monthly check-ins
- Problem-solving (if jobs slow down)
- Goal setting (save for own phone next time)

**3. Credit Building:**
- We report payments to credit bureaus
- Positive payment history builds credit score
- After 12 months on-time: ~50 point credit boost
- Opens doors: car loans, apartments, etc.

**4. Ownership Ceremony:**
- Final payment celebrated
- Phone officially unlocked and transferred
- Certificate of completion
- Featured on platform as "Success Story"

### **The Mindset Shift:**

**Old way:** "I need a phone, I'll finance it and hope I can pay"
**Our way:** "I'll work hard, advance tiers, EARN a phone, prove I'm responsible"

**Result:** Phone becomes symbol of achievement, not just a tool.

---

## üìä **Program Structure (Database Schema):**

<function_calls>
<invoke name="create_file">
<parameter name="content">-- Phone Financing & Responsibility Program Schema
-- Integrates with tier system and platform earnings

-- ============================================
-- DONATED PHONES TRACKING
-- ============================================

CREATE TABLE donated_phones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- Phone Details
  imei TEXT UNIQUE NOT NULL,
  make TEXT, -- Apple, Samsung, etc.
  model TEXT, -- iPhone 13 Pro, Galaxy S21, etc.
  condition TEXT CHECK (condition IN ('excellent', 'good', 'fair', 'poor')),
  estimated_value DECIMAL(10,2),
  
  -- Donation Details
  donated_at TIMESTAMPTZ DEFAULT NOW(),
  donation_method TEXT, -- 'drop_box', 'mail', 'in_person'
  donor_anonymous BOOLEAN DEFAULT TRUE,
  donor_id UUID REFERENCES profiles(id), -- NULL if anonymous
  
  -- IMEI Status Check
  imei_status TEXT CHECK (imei_status IN ('clean', 'blacklisted_stolen', 'locked_contract_default', 'unknown')),
  carrier_name TEXT, -- AT&T, Verizon, T-Mobile
  contract_balance_owed DECIMAL(10,2), -- Amount still owed to carrier
  original_owner_notified BOOLEAN DEFAULT FALSE,
  original_owner_claim_deadline TIMESTAMPTZ,
  
  -- Disposition
  phone_status TEXT CHECK (phone_status IN ('received', 'imei_checked', 'owner_notified', 'claimed', 'donated_back', 'ready_for_program', 'assigned', 'locked_again')) DEFAULT 'received',
  program_type TEXT CHECK (program_type IN ('sweepstakes', 'tier_financing', 'direct_donation', 'recycled')),
  
  -- Sweepstakes Integration
  sweepstakes_prize BOOLEAN DEFAULT FALSE,
  raffle_tickets_issued INTEGER DEFAULT 0,
  
  -- Notes
  notes TEXT
);

CREATE INDEX idx_donated_phones_imei_status ON donated_phones(imei_status);
CREATE INDEX idx_donated_phones_carrier ON donated_phones(carrier_name);
CREATE INDEX idx_donated_phones_status ON donated_phones(phone_status);

-- ============================================
-- CARRIER PARTNERSHIPS
-- ============================================

CREATE TABLE carrier_partnerships (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  carrier_name TEXT UNIQUE NOT NULL,
  
  -- Partnership Details
  partnership_active BOOLEAN DEFAULT FALSE,
  partnership_start_date DATE,
  contact_name TEXT,
  contact_email TEXT,
  contact_phone TEXT,
  
  -- Agreement Terms
  accepts_device_donations BOOLEAN DEFAULT FALSE,
  unlocks_contract_defaults BOOLEAN DEFAULT FALSE,
  provides_sweepstakes_prizes BOOLEAN DEFAULT FALSE,
  offers_service_discounts BOOLEAN DEFAULT FALSE,
  
  -- Financial Terms
  balance_recovery_agreement BOOLEAN DEFAULT FALSE, -- We pay back balances owed
  payment_terms_months INTEGER, -- 3, 6, or 12 months to pay balance
  service_discount_percent DECIMAL(5,2), -- e.g., 20% off for members
  
  -- API Access
  imei_api_access BOOLEAN DEFAULT FALSE,
  imei_api_endpoint TEXT,
  imei_api_key TEXT,
  
  -- Metrics
  phones_recovered INTEGER DEFAULT 0,
  total_balance_recovered DECIMAL(10,2) DEFAULT 0,
  new_customers_acquired INTEGER DEFAULT 0,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================
-- TIER-BASED PHONE FINANCING
-- ============================================

CREATE TABLE phone_financing_agreements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- Member & Phone
  member_id UUID NOT NULL REFERENCES profiles(id),
  phone_id UUID NOT NULL REFERENCES donated_phones(id),
  
  -- Eligibility (Tier-based)
  member_tier TEXT CHECK (member_tier IN ('bronze', 'silver', 'gold', 'platinum')) NOT NULL,
  tier_qualified_at TIMESTAMPTZ NOT NULL,
  platform_jobs_completed INTEGER NOT NULL, -- Must meet minimum
  platform_on_time_percentage DECIMAL(5,2) NOT NULL, -- Must meet minimum
  platform_active_months INTEGER NOT NULL,
  
  -- Financing Terms
  phone_value DECIMAL(10,2) NOT NULL, -- Fair market value
  carrier_balance_owed DECIMAL(10,2) DEFAULT 0, -- If contract default phone
  handling_fee DECIMAL(10,2) NOT NULL, -- Nonprofit fee (10-15%)
  total_financed DECIMAL(10,2) NOT NULL, -- phone_value + handling_fee
  
  weekly_payment DECIMAL(10,2) NOT NULL,
  total_weeks INTEGER NOT NULL,
  payments_made INTEGER DEFAULT 0,
  total_paid DECIMAL(10,2) DEFAULT 0,
  
  -- Payment Tracking
  next_payment_due DATE,
  last_payment_date DATE,
  missed_payments INTEGER DEFAULT 0,
  grace_periods_used INTEGER DEFAULT 0,
  
  -- Status
  agreement_status TEXT CHECK (agreement_status IN ('active', 'completed', 'defaulted', 'paused', 'reinstated')) DEFAULT 'active',
  
  -- Completion
  completed_at TIMESTAMPTZ,
  phone_ownership_transferred BOOLEAN DEFAULT FALSE,
  
  -- Default Handling
  defaulted_at TIMESTAMPTZ,
  default_reason TEXT,
  phone_locked_remotely BOOLEAN DEFAULT FALSE,
  reinstatement_offered BOOLEAN DEFAULT FALSE,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_financing_member ON phone_financing_agreements(member_id);
CREATE INDEX idx_financing_status ON phone_financing_agreements(agreement_status);
CREATE INDEX idx_financing_next_payment ON phone_financing_agreements(next_payment_due) WHERE agreement_status = 'active';

-- ============================================
-- PAYMENT SCHEDULE & HISTORY
-- ============================================

CREATE TABLE phone_financing_payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  financing_agreement_id UUID NOT NULL REFERENCES phone_financing_agreements(id),
  member_id UUID NOT NULL REFERENCES profiles(id),
  
  -- Payment Details
  payment_number INTEGER NOT NULL, -- 1, 2, 3... up to total_weeks
  scheduled_date DATE NOT NULL,
  scheduled_amount DECIMAL(10,2) NOT NULL,
  
  -- Actual Payment
  paid_date DATE,
  paid_amount DECIMAL(10,2),
  payment_status TEXT CHECK (payment_status IN ('pending', 'paid', 'missed', 'grace', 'waived')) DEFAULT 'pending',
  
  -- Payment Source
  payment_method TEXT CHECK (payment_method IN ('job_auto_deduct', 'manual_payment', 'emergency_fund', 'waived')),
  job_payment_id UUID, -- If deducted from job earnings
  
  -- Carrier Payment (if contract default phone)
  paid_to_carrier BOOLEAN DEFAULT FALSE,
  carrier_payment_date DATE,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_payments_agreement ON phone_financing_payments(financing_agreement_id);
CREATE INDEX idx_payments_status ON phone_financing_payments(payment_status);
CREATE INDEX idx_payments_scheduled ON phone_financing_payments(scheduled_date);

-- ============================================
-- MEMBER TIER ELIGIBILITY
-- ============================================

CREATE TABLE member_phone_eligibility (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  member_id UUID NOT NULL REFERENCES profiles(id),
  
  -- Current Tier Status
  current_tier TEXT CHECK (current_tier IN ('bronze', 'silver', 'gold', 'platinum')),
  tier_achieved_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Platform Metrics (Auto-calculated)
  platform_active_months INTEGER DEFAULT 0,
  total_jobs_completed INTEGER DEFAULT 0,
  on_time_delivery_percentage DECIMAL(5,2) DEFAULT 100.00,
  average_rating DECIMAL(3,2) DEFAULT 5.00,
  voluntary_donations_paid DECIMAL(10,2) DEFAULT 0,
  
  -- Financing History
  previous_financings_completed INTEGER DEFAULT 0,
  previous_financings_defaulted INTEGER DEFAULT 0,
  total_financed_to_date DECIMAL(10,2) DEFAULT 0,
  total_paid_on_time DECIMAL(10,2) DEFAULT 0,
  
  -- Current Eligibility
  eligible_for_financing BOOLEAN DEFAULT FALSE,
  max_phone_value DECIMAL(10,2) DEFAULT 0, -- Based on tier
  max_weekly_payment DECIMAL(10,2) DEFAULT 0,
  
  -- Restrictions
  restricted BOOLEAN DEFAULT FALSE,
  restriction_reason TEXT,
  restriction_expires_at TIMESTAMPTZ,
  
  last_calculated_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_eligibility_member ON member_phone_eligibility(member_id);

-- ============================================
-- HELPER FUNCTIONS
-- ============================================

-- Function: Calculate member tier eligibility
CREATE OR REPLACE FUNCTION calculate_member_phone_eligibility(p_member_id UUID)
RETURNS TABLE (
  tier TEXT,
  eligible BOOLEAN,
  max_phone_value DECIMAL,
  max_weekly_payment DECIMAL,
  reason TEXT
) AS $$
DECLARE
  v_active_months INTEGER;
  v_jobs_completed INTEGER;
  v_on_time_pct DECIMAL;
  v_avg_rating DECIMAL;
  v_previous_defaults INTEGER;
BEGIN
  -- Get member metrics (simplified - would integrate with actual platform data)
  SELECT 
    EXTRACT(MONTH FROM AGE(NOW(), created_at))::INTEGER,
    0, -- jobs_completed (would count from jobs table)
    100.00, -- on_time_percentage (would calculate from jobs)
    5.00 -- average_rating (would calculate from reviews)
  INTO v_active_months, v_jobs_completed, v_on_time_pct, v_avg_rating
  FROM profiles
  WHERE id = p_member_id;
  
  -- Check for previous defaults
  SELECT COUNT(*)
  INTO v_previous_defaults
  FROM phone_financing_agreements
  WHERE member_id = p_member_id
    AND agreement_status = 'defaulted';
  
  -- If any defaults, not eligible
  IF v_previous_defaults > 0 THEN
    RETURN QUERY SELECT 
      'none'::TEXT,
      FALSE,
      0::DECIMAL,
      0::DECIMAL,
      'Previous financing default - must reinstate first'::TEXT;
    RETURN;
  END IF;
  
  -- Determine tier and eligibility
  IF v_active_months >= 24 AND v_jobs_completed >= 100 AND v_on_time_pct >= 98 THEN
    RETURN QUERY SELECT 
      'platinum'::TEXT,
      TRUE,
      1000::DECIMAL,
      30::DECIMAL,
      'Qualified for Platinum tier - Premium flagship phones'::TEXT;
  ELSIF v_active_months >= 12 AND v_jobs_completed >= 50 AND v_on_time_pct >= 95 THEN
    RETURN QUERY SELECT 
      'gold'::TEXT,
      TRUE,
      600::DECIMAL,
      25::DECIMAL,
      'Qualified for Gold tier - High-end phones'::TEXT;
  ELSIF v_active_months >= 6 AND v_jobs_completed >= 25 AND v_on_time_pct >= 90 THEN
    RETURN QUERY SELECT 
      'silver'::TEXT,
      TRUE,
      400::DECIMAL,
      20::DECIMAL,
      'Qualified for Silver tier - Mid-range phones'::TEXT;
  ELSIF v_active_months >= 3 AND v_jobs_completed >= 10 THEN
    RETURN QUERY SELECT 
      'bronze'::TEXT,
      TRUE,
      300::DECIMAL,
      15::DECIMAL,
      'Qualified for Bronze tier - Budget phones'::TEXT;
  ELSE
    RETURN QUERY SELECT 
      'none'::TEXT,
      FALSE,
      0::DECIMAL,
      0::DECIMAL,
      'Need more platform activity - keep completing jobs!'::TEXT;
  END IF;
END;
$$ LANGUAGE plpgsql;

-- Function: Process automatic payment from job earnings
CREATE OR REPLACE FUNCTION process_phone_payment_from_job(
  p_member_id UUID,
  p_job_payment_amount DECIMAL,
  p_job_payment_id UUID
) RETURNS DECIMAL AS $$
DECLARE
  v_financing_id UUID;
  v_payment_due DECIMAL;
  v_payment_id UUID;
  v_remaining_amount DECIMAL;
BEGIN
  -- Find active financing agreement
  SELECT id, weekly_payment
  INTO v_financing_id, v_payment_due
  FROM phone_financing_agreements
  WHERE member_id = p_member_id
    AND agreement_status = 'active'
    AND next_payment_due <= CURRENT_DATE
  LIMIT 1;
  
  -- If no active financing, return full job amount
  IF v_financing_id IS NULL THEN
    RETURN p_job_payment_amount;
  END IF;
  
  -- If job payment is less than payment due, apply what we can
  IF p_job_payment_amount < v_payment_due THEN
    -- Partial payment (would trigger grace period logic)
    RETURN p_job_payment_amount; -- Don't deduct, let them pay manually
  END IF;
  
  -- Find next pending payment
  SELECT id
  INTO v_payment_id
  FROM phone_financing_payments
  WHERE financing_agreement_id = v_financing_id
    AND payment_status = 'pending'
  ORDER BY payment_number ASC
  LIMIT 1;
  
  -- Record payment
  UPDATE phone_financing_payments
  SET 
    paid_date = CURRENT_DATE,
    paid_amount = v_payment_due,
    payment_status = 'paid',
    payment_method = 'job_auto_deduct',
    job_payment_id = p_job_payment_id
  WHERE id = v_payment_id;
  
  -- Update financing agreement
  UPDATE phone_financing_agreements
  SET 
    payments_made = payments_made + 1,
    total_paid = total_paid + v_payment_due,
    last_payment_date = CURRENT_DATE,
    next_payment_due = next_payment_due + INTERVAL '7 days',
    updated_at = NOW()
  WHERE id = v_financing_id;
  
  -- Check if completed
  IF (SELECT payments_made FROM phone_financing_agreements WHERE id = v_financing_id) >= 
     (SELECT total_weeks FROM phone_financing_agreements WHERE id = v_financing_id) THEN
    UPDATE phone_financing_agreements
    SET 
      agreement_status = 'completed',
      completed_at = NOW(),
      phone_ownership_transferred = TRUE
    WHERE id = v_financing_id;
  END IF;
  
  -- Return remaining job payment after deduction
  v_remaining_amount := p_job_payment_amount - v_payment_due;
  RETURN v_remaining_amount;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- TRIGGERS
-- ============================================

-- Auto-update timestamps
CREATE TRIGGER update_carrier_partnerships_updated_at
  BEFORE UPDATE ON carrier_partnerships
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_financing_agreements_updated_at
  BEFORE UPDATE ON phone_financing_agreements
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_member_eligibility_updated_at
  BEFORE UPDATE ON member_phone_eligibility
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- SAMPLE DATA
-- ============================================

-- Insert tier requirements reference
COMMENT ON TABLE member_phone_eligibility IS 
'Tier Requirements:
- Bronze: 3+ months active, 10+ jobs, any on-time % ‚Üí Max $300 phone, $15/week
- Silver: 6+ months active, 25+ jobs, 90%+ on-time ‚Üí Max $600 phone, $20/week  
- Gold: 12+ months active, 50+ jobs, 95%+ on-time ‚Üí Max $1000 phone, $25/week
- Platinum: 24+ months active, 100+ jobs, 98%+ on-time ‚Üí Premium phones, $30/week';
