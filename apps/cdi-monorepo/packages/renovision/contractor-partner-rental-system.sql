# üèóÔ∏è Member-Driven Phone Distribution Network
## *Contractors as Device Rental Partners*

---

## üéØ **THE BREAKTHROUGH INSIGHT:**

### **Old Model (You Do Everything):**
```
You approach stores ‚ùå
You handle IMEI checks ‚ùå
You manage individual members ‚ùå
You track all payments ‚ùå
YOU ARE THE BOTTLENECK ‚ùå
```

### **NEW Model (Contractors Do The Work):**
```
Contractors with EIN/LLC status become partners ‚úÖ
They manage their own crews' phones ‚úÖ
They handle store relationships ‚úÖ
They collect payments from workers ‚úÖ
YOU JUST PROVIDE PHONES & OVERSIGHT ‚úÖ
```

---

## üí° **THE CONTRACTOR-PARTNER SYSTEM:**

### **Who Qualifies as Contractor-Partner:**

**Tier 1: Board Members** (Founding Partners)
- Automatic approval
- First access to devices
- Can manage unlimited crew phones
- Gets referral bonuses

**Tier 2: Established Contractors** (Proven Members)
- Must have: EIN + LLC registration
- Platform history: 6+ months, 25+ jobs
- Crew size: 2+ regular workers/helpers
- Can manage up to 10 crew phones

**Tier 3: Solo Contractors** (Individual Access)
- Personal use only (not crew management)
- Standard tier-based eligibility
- Can upgrade to Tier 2 when they hire crew

---

## üì± **HOW IT WORKS:**

### **Step 1: Phone Collection (Same as Before)**
```
Members donate phones ‚Üí Sweepstakes entries
  ‚Üì
Nonprofit receives 100 phones/month
  ‚Üì
Instead of managing individually...
  ‚Üì
Bundle phones by network carrier
```

### **Step 2: Contractor-Partner Gets Phone Bundle**
```
Contractor John (verified LLC) requests phones
  ‚Üì
"I have 4 workers who need phones"
  ‚Üì
Nonprofit checks inventory:
  - 3 AT&T/Cricket phones available
  - 1 T-Mobile/Metro phone available
  ‚Üì
Rental Agreement: $100/month for all 4 phones
  ‚Üì
John gets 4 phones (donated, $0 nonprofit cost)
```

### **Step 3: Contractor Handles Store Relationship**
```
John takes phones to local Metro PCS
  ‚Üì
"I need 4 lines for my crew - no contract plan"
  ‚Üì
Metro: "4 for $100/month!"
  ‚Üì
John: "These phones locked to T-Mobile still owe 12 months"
  ‚Üì
Metro: "No problem - we'll unlock for our plan, stays locked to T-Mobile network for remainder"
  ‚Üì
John activates all 4 lines
  ‚Üì
John manages his own crew's service
```

### **Step 4: Contractor Pays Nonprofit**
```
John's monthly costs:
  - Service from Metro: $100 (4 lines)
  - Phone rental to nonprofit: $100 (4 devices)
  - Total: $200/month
  
John charges his workers:
  - $60/month each √ó 4 workers = $240/month
  - OR: Deducts from their pay automatically
  - John's profit: $40/month (for managing)
  
Nonprofit gets:
  - $100/month pure profit (donated phones)
  - Zero work (John handles everything)
  - Zero risk (phones were free)
```

### **Step 5: If Contractor Stops Paying**
```
Month 6: John misses payment to nonprofit
  ‚Üì
Nonprofit response: Flag account
  ‚Üì
John cannot rent more devices until current
  ‚Üì
BUT: John keeps the 4 phones! (We don't repossess)
  ‚Üì
Why? Phones cost us $0 (donated)
  ‚Üì
John's workers still have service (keeps them employed)
  ‚Üì
John still owes $100 but no urgency
  ‚Üì
When John wants more phones: Must pay arrears
```

---

## üèóÔ∏è **THE CONTRACTOR-PARTNER BENEFITS:**

### **What Contractors Get:**

‚úÖ **Crew Management Tool:**
- Equip workers with phones (professionalism)
- Deduct cost from worker pay (automatic)
- Control service (suspend if worker quits)
- Track worker communications

‚úÖ **Profit Opportunity:**
```
Pay nonprofit: $100/month (4 phones)
Pay carrier: $100/month (4 lines)
Total cost: $200/month

Charge workers: $60/month each
Total income: $240/month

NET PROFIT: $40/month passive income
```

‚úÖ **Business Legitimacy:**
- Provide phones as employee benefit
- Tax deductible business expense
- Professional crew appearance
- Easier worker recruitment

‚úÖ **Flexibility:**
- No long-term contracts (month-to-month)
- Scale up/down with crew size
- Cancel anytime (no penalty)
- Keep phones even if stop paying nonprofit

---

## üéØ **NONPROFIT BENEFITS (THIS IS THE GENIUS PART):**

### **Zero Risk, Pure Profit:**

```
Cost to acquire phones: $0 (donated)
Cost to manage: $0 (contractors handle it)
Risk if non-payment: $0 (already free)

Revenue: $100/month per contractor-partner
With 50 contractors: $5,000/month = $60,000/year!
```

### **Scalability Through Distribution:**

**Old Model:**
```
You manage 100 individual members
  ‚Üì
100 store visits
100 IMEI checks
100 payment accounts
100 customer service issues
= NIGHTMARE
```

**New Model:**
```
You manage 20 contractor-partners
  ‚Üì
They each manage 5-10 crew members
  ‚Üì
20 payment accounts (simple!)
20 relationships (manageable)
Contractors handle everything else
= EASY SCALE
```

### **Network Effects:**

```
Contractor John succeeds
  ‚Üì
His crew gets phones, works better
  ‚Üì
John tells other contractors
  ‚Üì
5 more contractors join
  ‚Üì
Each brings 4-6 workers
  ‚Üì
Nonprofit now serving 150+ workers
  ‚Üì
Only managing 25 contractor accounts!
```

---

## üîÑ **THE NETWORK-SPECIFIC PHONE ASSIGNMENT:**

### **Smart Inventory Management:**

```
Phone donated ‚Üí Check IMEI
  ‚Üì
Carrier: AT&T
Balance owed: $400 (12 months left)
  ‚Üì
Tagged in database: "AT&T/Cricket compatible, 12mo locked"
  ‚Üì
Available to contractors who use Cricket/AT&T
```

### **Contractor Matching:**

```
Contractor Maria requests phones
  ‚Üì
"I use Metro PCS for my crew"
  ‚Üì
System searches inventory:
  - T-Mobile/Metro phones: 8 available
  - 4 unlocked (ready immediately)
  - 4 locked (6 months remaining)
  ‚Üì
Offer Maria the 4 unlocked phones first
  ‚Üì
Maria activates with Metro same day!
```

### **The Lock-to-Network Advantage:**

**How Carriers Handle Contract Defaults:**

```
iPhone locked to AT&T, 12 months left on contract
  ‚Üì
Customer 1 donated it (couldn't pay)
  ‚Üì
Contractor gets it from nonprofit
  ‚Üì
Takes to Cricket (AT&T network)
  ‚Üì
Cricket: "This phone owes AT&T $400"
  ‚Üì
Cricket: "We can activate it on NO-CONTRACT plan"
  ‚Üì
Phone stays locked to AT&T/Cricket network
  ‚Üì
After 12 months of service: Unlocks automatically!
  ‚Üì
Now works on any carrier
```

**Why This Works:**
- Carrier gets service revenue (even though device unpaid)
- Phone stays on their network (locked)
- After contract period: Unlocks (industry standard)
- Everyone wins!

---

## üìã **THE RENTAL AGREEMENT STRUCTURE:**

### **Contractor-Partner Device Rental Agreement:**

```
DEVICE RENTAL AGREEMENT
Between: [Nonprofit Name]
And: [Contractor Name / LLC]

CONTRACTOR DETAILS:
Legal Business Name: _______________
EIN: _______________
LLC Registration: ‚òëÔ∏è Verified
Platform History: 6+ months ‚òëÔ∏è

DEVICES RENTED:
Qty: 4 phones
Networks: 3√ó AT&T/Cricket, 1√ó T-Mobile/Metro
IMEI Numbers: [listed]
Estimated Value: $1,400 (fair market)

RENTAL TERMS:
Monthly Rental: $100 for all 4 devices
Payment Due: 1st of each month
Payment Method: Auto-deduct from job payments OR manual

CONTRACTOR RESPONSIBILITIES:
‚úÖ Activate service with compatible carrier
‚úÖ Manage crew member usage
‚úÖ Handle any carrier-related issues
‚úÖ Pay monthly rental to nonprofit

NONPROFIT RESPONSIBILITIES:
‚úÖ Provide working devices
‚úÖ Support with carrier compatibility questions
‚úÖ Track payment history

TERMINATION:
- Contractor may cancel anytime (30 days notice)
- Devices REMAIN WITH CONTRACTOR (no return required)
- Unpaid balance blocks future device rentals
- No collections, no repossession

OWNERSHIP:
Devices remain nonprofit property unless:
  ‚úÖ 24 months rental paid = Ownership transfers
  ‚úÖ Or: Contractor buys out ($200/phone flat rate)

Signed: _________________ Date: _______
        (Contractor)

Signed: _________________ Date: _______
        (Nonprofit Director)
```

**KEY FEATURES:**
- Month-to-month (no long-term commitment)
- No repossession (donated phones, zero cost)
- Path to ownership (24 months OR buyout)
- Contractor manages crew (nonprofit hands-off)

---

## üí∞ **FINANCIAL MODELS:**

### **Model 1: Contractor Provides Phones as Benefit**

```
Contractor pays:
  - Nonprofit rental: $100/month (4 phones)
  - Carrier service: $100/month (4 lines)
  - Total: $200/month

Contractor DOES NOT charge workers

Benefits:
  ‚úÖ Attract better workers (free phone/service!)
  ‚úÖ Tax deductible business expense
  ‚úÖ Worker loyalty (don't want to lose benefit)
  ‚úÖ Professional crew (all have phones)

Cost per worker: $50/month
If workers produce $500+ extra value: ROI positive!
```

### **Model 2: Contractor Charges Workers (Pass-Through)**

```
Contractor pays:
  - Nonprofit rental: $100/month (4 phones)
  - Carrier service: $100/month (4 lines)
  - Total: $200/month

Contractor charges workers:
  - $50/month each (exactly cost)
  - Deducted from weekly pay ($12.50/week)

Benefits:
  ‚úÖ Zero cost to contractor (break-even)
  ‚úÖ Workers get affordable phones
  ‚úÖ Contractor handles convenience (one bill)
  ‚úÖ Workers don't need good credit

Contractor profit: $0
But: Zero cost crew communication = VALUE
```

### **Model 3: Contractor Marks Up (Profit Center)**

```
Contractor pays:
  - Nonprofit rental: $100/month (4 phones)
  - Carrier service: $100/month (4 lines)
  - Total: $200/month

Contractor charges workers:
  - $60/month each (4 workers)
  - Total: $240/month

Benefits:
  ‚úÖ Contractor profit: $40/month passive
  ‚úÖ Covers contractor's own phone too
  ‚úÖ Administrative fee for managing
  ‚úÖ Workers still pay less than market ($60 vs $80)

Win-win-win:
  - Workers: Cheaper than solo plan
  - Contractor: Passive income
  - Nonprofit: Device rental revenue
```

---

## üöÄ **SCALING STRATEGY:**

### **Phase 1: Founding Partners (Board Members)**

```
Month 1: Offer to 5 board members
  ‚Üì
Each has 3-5 crew members
  ‚Üì
Total: 15-25 phones distributed
  ‚Üì
Revenue: $500-1,000/month
  ‚Üì
Test model, refine process
```

### **Phase 2: Established Contractors**

```
Month 3: Open to verified LLC contractors
  ‚Üì
10 contractors join (avg 5 crew each)
  ‚Üì
50 phones distributed
  ‚Üì
Revenue: $2,500/month
  ‚Üì
Prove scalability
```

### **Phase 3: Open Enrollment**

```
Month 6: Any contractor can apply
  ‚Üì
50 contractors active
  ‚Üì
250+ phones distributed
  ‚Üì
Revenue: $12,500/month = $150K/year!
  ‚Üì
Sustainable program
```

### **Phase 4: Multi-City Expansion**

```
Year 2: White-label to other cities
  ‚Üì
Partner with other nonprofits
  ‚Üì
"Phone Rental Program in a Box"
  ‚Üì
Franchise model
  ‚Üì
National impact!
```

---

## üéØ **THE TRUST & ACCOUNTABILITY SYSTEM:**

### **Contractor Verification Tiers:**

**Bronze Tier (New Contractors):**
- Requirements: EIN + LLC + 3 months platform history
- Max phones: 5 devices
- Rental rate: $100/month flat (up to 5 phones)
- Deposit: $100 (refundable after 6 months good standing)

**Silver Tier (Proven Contractors):**
- Requirements: 6+ months rental history, no missed payments
- Max phones: 10 devices
- Rental rate: $150/month (6-10 phones)
- No deposit required
- Referral bonus: $20 per contractor you bring in

**Gold Tier (Partner Distributors):**
- Requirements: 12+ months, 10+ phones, referred 3+ contractors
- Max phones: Unlimited
- Rental rate: $15/phone/month (wholesale pricing)
- Can sublet to other contractors (distributor model)
- Revenue share on referrals

**Platinum Tier (Board Members):**
- Automatic approval
- Free first 5 phones (board benefit)
- $10/phone after first 5
- Leadership role in program growth

---

## üìä **DATABASE SCHEMA ADDITIONS:**

<function_calls>
<invoke name="create_file">
<parameter name="content">-- Contractor-Partner Phone Rental System
-- Members become distributors managing crew phones

-- ============================================
-- CONTRACTOR PARTNER ACCOUNTS
-- ============================================

CREATE TABLE contractor_partners (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- Contractor Details
  member_id UUID NOT NULL REFERENCES profiles(id),
  business_name TEXT NOT NULL,
  ein TEXT NOT NULL, -- Employer Identification Number
  llc_registration_verified BOOLEAN DEFAULT FALSE,
  llc_registration_state TEXT,
  llc_registration_number TEXT,
  llc_verification_doc_url TEXT, -- Upload proof
  
  -- Partner Tier
  partner_tier TEXT CHECK (partner_tier IN ('bronze', 'silver', 'gold', 'platinum')) DEFAULT 'bronze',
  tier_qualified_date TIMESTAMPTZ DEFAULT NOW(),
  is_board_member BOOLEAN DEFAULT FALSE,
  
  -- Rental Limits
  max_devices_allowed INTEGER DEFAULT 5,
  current_devices_rented INTEGER DEFAULT 0,
  
  -- Financial
  monthly_rental_rate DECIMAL(10,2) NOT NULL, -- Depends on tier
  deposit_amount DECIMAL(10,2) DEFAULT 0,
  deposit_paid BOOLEAN DEFAULT FALSE,
  deposit_refundable_after TIMESTAMPTZ,
  
  -- Payment Status
  account_status TEXT CHECK (account_status IN ('active', 'suspended', 'good_standing', 'arrears')) DEFAULT 'active',
  total_paid_to_date DECIMAL(10,2) DEFAULT 0,
  balance_owed DECIMAL(10,2) DEFAULT 0,
  last_payment_date DATE,
  next_payment_due DATE,
  
  -- Referral Program
  referred_by_partner_id UUID REFERENCES contractor_partners(id),
  referral_bonus_earned DECIMAL(10,2) DEFAULT 0,
  contractors_referred INTEGER DEFAULT 0,
  
  -- Performance Metrics
  months_active INTEGER DEFAULT 0,
  missed_payments INTEGER DEFAULT 0,
  on_time_payment_percentage DECIMAL(5,2) DEFAULT 100.00,
  
  -- Notes
  notes TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_contractor_partners_member ON contractor_partners(member_id);
CREATE INDEX idx_contractor_partners_tier ON contractor_partners(partner_tier);
CREATE INDEX idx_contractor_partners_status ON contractor_partners(account_status);
CREATE INDEX idx_contractor_partners_board ON contractor_partners(is_board_member) WHERE is_board_member = TRUE;

-- ============================================
-- DEVICE RENTAL ASSIGNMENTS
-- ============================================

CREATE TABLE device_rental_assignments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- Rental Details
  contractor_partner_id UUID NOT NULL REFERENCES contractor_partners(id),
  donated_phone_id UUID NOT NULL REFERENCES donated_phones(id),
  
  -- Device Info (denormalized for quick access)
  device_imei TEXT NOT NULL,
  device_make TEXT,
  device_model TEXT,
  device_network TEXT, -- AT&T, T-Mobile, Verizon
  months_locked_remaining INTEGER DEFAULT 0, -- Contract remainder
  
  -- Assignment Details
  assigned_date DATE NOT NULL DEFAULT CURRENT_DATE,
  monthly_rental_fee DECIMAL(10,2) NOT NULL, -- Portion of total rental
  
  -- Crew Member Assignment
  assigned_to_crew_member_name TEXT, -- Optional: Track who has it
  assigned_to_crew_member_phone TEXT,
  
  -- Service Activation
  activated_with_carrier TEXT, -- Cricket, Metro, Boost
  carrier_phone_number TEXT, -- Actual activated number
  activation_date DATE,
  
  -- Status
  rental_status TEXT CHECK (rental_status IN ('assigned', 'activated', 'suspended', 'returned', 'owned')) DEFAULT 'assigned',
  
  -- Ownership Path
  months_rented INTEGER DEFAULT 0,
  ownership_threshold_months INTEGER DEFAULT 24, -- Becomes owned after 24 months
  owned_outright BOOLEAN DEFAULT FALSE,
  ownership_transferred_date DATE,
  
  -- Buyout Option
  buyout_price DECIMAL(10,2) DEFAULT 200.00, -- Flat $200/phone
  bought_out BOOLEAN DEFAULT FALSE,
  buyout_date DATE,
  
  -- Return
  returned_date DATE,
  return_reason TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_device_rental_contractor ON device_rental_assignments(contractor_partner_id);
CREATE INDEX idx_device_rental_phone ON device_rental_assignments(donated_phone_id);
CREATE INDEX idx_device_rental_status ON device_rental_assignments(rental_status);
CREATE INDEX idx_device_rental_network ON device_rental_assignments(device_network);

-- ============================================
-- CONTRACTOR PARTNER PAYMENTS
-- ============================================

CREATE TABLE contractor_partner_payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- Payment Details
  contractor_partner_id UUID NOT NULL REFERENCES contractor_partners(id),
  payment_month DATE NOT NULL, -- e.g., 2025-11-01
  
  -- Billing
  devices_count INTEGER NOT NULL,
  rental_rate_per_device DECIMAL(10,2),
  total_rental_due DECIMAL(10,2) NOT NULL,
  
  -- Payment
  amount_paid DECIMAL(10,2) DEFAULT 0,
  payment_date DATE,
  payment_status TEXT CHECK (payment_status IN ('pending', 'paid', 'partial', 'missed')) DEFAULT 'pending',
  payment_method TEXT CHECK (payment_method IN ('job_auto_deduct', 'manual_payment', 'bank_transfer', 'cash')),
  
  -- Auto-deduction from jobs
  job_payment_id UUID, -- If deducted from contractor's job payment
  
  -- Late fees (optional)
  late_fee DECIMAL(10,2) DEFAULT 0,
  grace_period_ends DATE,
  
  -- Notes
  notes TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_contractor_payments_partner ON contractor_partner_payments(contractor_partner_id);
CREATE INDEX idx_contractor_payments_month ON contractor_partner_payments(payment_month);
CREATE INDEX idx_contractor_payments_status ON contractor_partner_payments(payment_status);

-- ============================================
-- CREW MEMBER REGISTRY (Optional Tracking)
-- ============================================

CREATE TABLE crew_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- Crew Member Details
  contractor_partner_id UUID NOT NULL REFERENCES contractor_partners(id),
  crew_member_name TEXT NOT NULL,
  crew_member_phone TEXT,
  crew_member_email TEXT,
  
  -- Employment
  hire_date DATE,
  employment_status TEXT CHECK (employment_status IN ('active', 'inactive', 'terminated')) DEFAULT 'active',
  termination_date DATE,
  
  -- Phone Assignment
  has_company_phone BOOLEAN DEFAULT FALSE,
  device_rental_id UUID REFERENCES device_rental_assignments(id),
  monthly_charge_to_crew DECIMAL(10,2), -- What contractor charges them (if anything)
  payment_method TEXT CHECK (payment_method IN ('deducted_from_pay', 'direct_payment', 'company_benefit')),
  
  -- Notes
  notes TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_crew_members_contractor ON crew_members(contractor_partner_id);
CREATE INDEX idx_crew_members_status ON crew_members(employment_status);
CREATE INDEX idx_crew_members_has_phone ON crew_members(has_company_phone) WHERE has_company_phone = TRUE;

-- ============================================
-- REFERRAL TRACKING
-- ============================================

CREATE TABLE contractor_referrals (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  
  -- Referral Details
  referrer_partner_id UUID NOT NULL REFERENCES contractor_partners(id),
  referred_partner_id UUID NOT NULL REFERENCES contractor_partners(id),
  
  -- Referral Bonus
  referral_date DATE NOT NULL DEFAULT CURRENT_DATE,
  bonus_amount DECIMAL(10,2) DEFAULT 20.00,
  bonus_paid BOOLEAN DEFAULT FALSE,
  bonus_paid_date DATE,
  
  -- Conditions
  referred_partner_active_months INTEGER DEFAULT 0,
  bonus_qualifies BOOLEAN DEFAULT FALSE, -- TRUE after 3 months good standing
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_referrals_referrer ON contractor_referrals(referrer_partner_id);
CREATE INDEX idx_referrals_referred ON contractor_referrals(referred_partner_id);

-- ============================================
-- HELPER FUNCTIONS
-- ============================================

-- Function: Calculate contractor tier
CREATE OR REPLACE FUNCTION calculate_contractor_tier(p_contractor_partner_id UUID)
RETURNS TEXT AS $$
DECLARE
  v_months_active INTEGER;
  v_missed_payments INTEGER;
  v_devices_rented INTEGER;
  v_referrals INTEGER;
  v_is_board BOOLEAN;
BEGIN
  SELECT 
    months_active,
    missed_payments,
    current_devices_rented,
    contractors_referred,
    is_board_member
  INTO v_months_active, v_missed_payments, v_devices_rented, v_referrals, v_is_board
  FROM contractor_partners
  WHERE id = p_contractor_partner_id;
  
  -- Board members always Platinum
  IF v_is_board THEN
    RETURN 'platinum';
  END IF;
  
  -- Gold tier: 12+ months, 10+ devices, 3+ referrals
  IF v_months_active >= 12 AND v_devices_rented >= 10 AND v_referrals >= 3 AND v_missed_payments = 0 THEN
    RETURN 'gold';
  END IF;
  
  -- Silver tier: 6+ months, no missed payments
  IF v_months_active >= 6 AND v_missed_payments = 0 THEN
    RETURN 'silver';
  END IF;
  
  -- Bronze tier: Default
  RETURN 'bronze';
END;
$$ LANGUAGE plpgsql;

-- Function: Assign device to contractor
CREATE OR REPLACE FUNCTION assign_device_to_contractor(
  p_contractor_partner_id UUID,
  p_donated_phone_id UUID,
  p_assigned_to_crew_name TEXT DEFAULT NULL
) RETURNS UUID AS $$
DECLARE
  v_assignment_id UUID;
  v_current_devices INTEGER;
  v_max_allowed INTEGER;
  v_device_imei TEXT;
  v_device_network TEXT;
  v_monthly_fee DECIMAL;
BEGIN
  -- Check if contractor can rent more devices
  SELECT current_devices_rented, max_devices_allowed
  INTO v_current_devices, v_max_allowed
  FROM contractor_partners
  WHERE id = p_contractor_partner_id;
  
  IF v_current_devices >= v_max_allowed THEN
    RAISE EXCEPTION 'Contractor has reached maximum device limit (%))', v_max_allowed;
  END IF;
  
  -- Get device details
  SELECT imei, carrier_name
  INTO v_device_imei, v_device_network
  FROM donated_phones
  WHERE id = p_donated_phone_id;
  
  -- Determine rental fee (simplified - could be more complex)
  v_monthly_fee := 25.00; -- $25/device/month base rate
  
  -- Create assignment
  INSERT INTO device_rental_assignments (
    contractor_partner_id,
    donated_phone_id,
    device_imei,
    device_network,
    assigned_to_crew_member_name,
    monthly_rental_fee
  ) VALUES (
    p_contractor_partner_id,
    p_donated_phone_id,
    v_device_imei,
    v_device_network,
    p_assigned_to_crew_name,
    v_monthly_fee
  ) RETURNING id INTO v_assignment_id;
  
  -- Update contractor's device count
  UPDATE contractor_partners
  SET current_devices_rented = current_devices_rented + 1
  WHERE id = p_contractor_partner_id;
  
  -- Update phone status
  UPDATE donated_phones
  SET 
    phone_status = 'assigned',
    program_type = 'tier_financing'
  WHERE id = p_donated_phone_id;
  
  RETURN v_assignment_id;
END;
$$ LANGUAGE plpgsql;

-- Function: Check and update ownership after 24 months
CREATE OR REPLACE FUNCTION check_device_ownership_transfer()
RETURNS INTEGER AS $$
DECLARE
  v_transferred_count INTEGER := 0;
  v_assignment RECORD;
BEGIN
  FOR v_assignment IN
    SELECT id, contractor_partner_id, donated_phone_id
    FROM device_rental_assignments
    WHERE rental_status = 'activated'
      AND owned_outright = FALSE
      AND months_rented >= ownership_threshold_months
  LOOP
    -- Transfer ownership
    UPDATE device_rental_assignments
    SET 
      owned_outright = TRUE,
      ownership_transferred_date = CURRENT_DATE,
      rental_status = 'owned'
    WHERE id = v_assignment.id;
    
    -- Reduce contractor's rented count
    UPDATE contractor_partners
    SET current_devices_rented = GREATEST(0, current_devices_rented - 1)
    WHERE id = v_assignment.contractor_partner_id;
    
    v_transferred_count := v_transferred_count + 1;
  END LOOP;
  
  RETURN v_transferred_count;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- TRIGGERS
-- ============================================

CREATE TRIGGER update_contractor_partners_updated_at
  BEFORE UPDATE ON contractor_partners
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_device_rental_updated_at
  BEFORE UPDATE ON device_rental_assignments
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_crew_members_updated_at
  BEFORE UPDATE ON crew_members
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- TIER PRICING REFERENCE
-- ============================================

COMMENT ON TABLE contractor_partners IS
'Contractor-Partner Tiers:
- Bronze (New): Max 5 devices, $100/month flat (deposit $100)
- Silver (6mo): Max 10 devices, $150/month (6-10), no deposit
- Gold (12mo+): Unlimited devices, $15/device/month wholesale
- Platinum (Board): First 5 free, $10/device after

Ownership: 24 months rental = ownership transfer
Buyout: $200/phone anytime to own outright';

COMMENT ON TABLE device_rental_assignments IS
'Tracks which phones are rented to which contractors.
Contractors manage their own crew phone assignments.
Nonprofit only tracks contractor-level payments.
Zero repossession - if contractor stops paying, just blocks future rentals.';

COMMENT ON TABLE crew_members IS
'Optional tracking of contractor crew members.
Contractors can log who has which phone.
Useful for accountability but not required.
Contractor manages their own crew relationships.';
